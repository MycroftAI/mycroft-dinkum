import unittest

from fsticuffs.parser import ParseChunk, ParseType, next_chunk
from fsticuffs.expression import (
    parse_expression,
    Word,
    Sequence,
    SequenceType,
    Tag,
    SlotReference,
    RuleReference,
    Sentence,
    Number,
    NumberRange,
)

# -----------------------------------------------------------------------------


class WordTestCase(unittest.TestCase):
    def test_word(self):
        self.assertEqual(parse_expression(next_chunk("test")), w(text="test"))

    def test_word_sub(self):
        self.assertEqual(
            parse_expression(next_chunk("test:test2")),
            w(text="test", substitution="test2"),
        )

    def test_word_sub_multiple(self):
        self.assertEqual(
            parse_expression(next_chunk("test:(test2 test3)")),
            w(text="test", substitution=["test2", "test3"]),
        )

    def test_word_sub_empty(self):
        self.assertEqual(
            parse_expression(next_chunk("test:")),
            w(text="test", substitution=""),
        )


# -----------------------------------------------------------------------------


class SequenceTestCase(unittest.TestCase):
    def test_group(self):
        self.assertEqual(
            parse_expression(next_chunk("(test test2)")),
            group(
                items=[w(text="test"), w(text="test2")],
            ),
        )

    def test_group_sub_word(self):
        self.assertEqual(
            parse_expression(next_chunk("(test test2):test3")),
            group(items=[w(text="test"), w(text="test2")], substitution="test3"),
        )

    def test_group_sub_group(self):
        self.assertEqual(
            parse_expression(next_chunk("(test test2):(test3 test4)")),
            group(
                items=[w(text="test"), w(text="test2")], substitution=["test3", "test4"]
            ),
        )

    def test_group_tag(self):
        self.assertEqual(
            parse_expression(next_chunk("(test test2){test3}")),
            group(items=[w(text="test"), w(text="test2")], tag=Tag(tag_text="test3")),
        )

    def test_group_in_group(self):
        self.assertEqual(
            parse_expression(next_chunk("((test test2))")),
            group(
                items=[group(items=[w(text="test"), w(text="test2")])],
            ),
        )

    def test_optional(self):
        self.assertEqual(
            parse_expression(next_chunk("[test test2]")),
            alt(
                items=[
                    group(
                        items=[Word(text="test"), Word(text="test2")],
                    ),
                    Word.empty(),
                ],
            ),
        )

    def test_group_alternative(self):
        self.assertEqual(
            parse_expression(next_chunk("(test | test2)")),
            alt(
                items=[group(items=[w(text="test")]), group(items=[w(text="test2")])],
            ),
        )


# -----------------------------------------------------------------------------


class ReferenceTestCase(unittest.TestCase):
    def test_slot_reference(self):
        self.assertEqual(
            parse_expression(next_chunk("$test")), SlotReference(slot_name="test")
        )

    def test_rule_reference(self):
        self.assertEqual(
            parse_expression(next_chunk("<test>")), RuleReference(rule_name="test")
        )


# -----------------------------------------------------------------------------


class NumberTestCase(unittest.TestCase):
    def test_number(self):
        self.assertEqual(parse_expression(next_chunk("100")), Number(number=100))

    def test_number_range(self):
        self.assertEqual(
            parse_expression(next_chunk("1..100")),
            NumberRange(lower_bound=1, upper_bound=100),
        )

    def test_number_range_with_step(self):
        self.assertEqual(
            parse_expression(next_chunk("1..100,2")),
            NumberRange(lower_bound=1, upper_bound=100, step=2),
        )


# -----------------------------------------------------------------------------


class SentenceTestCase(unittest.TestCase):
    def test_no_group(self):
        self.assertEqual(
            Sentence.parse("this is a test"),
            Sentence(items=[w(text="this"), w(text="is"), w(text="a"), w(text="test")]),
        )

    def test_group(self):
        self.assertEqual(
            Sentence.parse("(this is a test)"),
            Sentence(items=[w(text="this"), w(text="is"), w(text="a"), w(text="test")]),
        )

    def test_optional(self):
        self.assertEqual(
            Sentence.parse("[this is a test]"),
            Sentence(
                type=SequenceType.ALTERNATIVE,
                items=[
                    group(
                        items=[
                            w(text="this"),
                            w(text="is"),
                            w(text="a"),
                            w(text="test"),
                        ]
                    ),
                    Word.empty(),
                ],
            ),
        )


# -----------------------------------------------------------------------------


def w(**kwargs):
    return Word(**kwargs)


def group(**kwargs):
    return Sequence(type=SequenceType.GROUP, **kwargs)


def alt(**kwargs):
    return Sequence(type=SequenceType.ALTERNATIVE, **kwargs)
